clear all;close all;clc

A = [0.9985 0 0;0 0.9985 0;0 0 0.9991];
B = [0 0.0058 0 -0.0058;-0.0058 0 0.0058 0;-0.0002 0.0002 -0.0002 0.0002];
C = eye(3);
F= eye(3);
E = [0.5 0.3 0 1.7;0.4 0 0.6 0;0.3 0.2 0.05 0.06];

B1=[0 0.0058 0 -0.0058;0 0 0.0058 0;0 0.0002 -0.0002 0.0002];
B2=[0 0 0 -0.0058;-0.0058 0 0.0058 0;-0.0002 0 -0.0002 0.0002];
B3=[0 0.0058 0 -0.0058;-0.0058 0 0 0;-0.0002 0.0002 0 0.0002];
B4=[0 0.0058 0 0;-0.0058 0 0.0058 0;-0.0002 0.0002 -0.0002 0];

E11=[0 0.5;-0.0058 0.4;-0.0002 0.3];
E21=[0.0058 0.5;0 0.4;0.0002 0.3];
E31=[0 0.5;0.0058 0.4;-0.0002 0.3];
E41=[-0.0058 0.5;0 0.4;0.0002 0.3];
E2=[0.3 0 1.7;0 0.6 0;0.2 0.05 0.06];

V=Polyhedron('lb',[-2 -2 -2]*10^(-3),'ub',[2 2 2]*10^(-3));
W2=Polyhedron('lb',[-2 -2 -2]*10^(-3),'ub',[2 2 2]*10^(-3));

% N1=[5.7257  6.7741  5.7676;-4.7021 -5.6668 -5.4171;-0.6817 -0.6970  0.3279];
% H1=[0.7502 -0.0123  0.4327;-0.0123  0.9994  0.0213;0.4327  0.0213  0.2504];
% T1=[0 0.0594  0.0061 -0.0655;0 -0.0735 -0.0076 0.0811;0 0.0339  0.0035 -0.0374];
M1=[0.7050  0.809  0.56;0.09  0.27  0.43;0.58  0.69  0.41];
% K11=[-1.9069 -2.0134  0.2479;1.4133  3.7500 -0.3910;0.5232 -1.8918  0.9533];
% K21=[1.2940  1.9833  0.8033;-0.8394 -3.7218 -0.5901;-0.8308  1.8767 -0.4264];
% N2=[-0.9789 -1.2320 -1.8896;1.1277  1.1467  1.2675;-1.0319 -0.8549 -0.3831];
% H2=[0.9995 -0.0134  0.0188;-0.0134  0.6622  0.4728;0.0188  0.4728  0.3384];
% T2=[-0.0075  0  0.0081 -0.0006;0.0005  0 -0.0006  0;0.0069  0 -0.0075  0.0006];
M2=[0.6 0.8 0.58;0.5 0.27  0.25;0.4 0.19  0.8];
% K12=[0.2296 -0.0856  0.0104;0.1005 -0.2476 -0.1269;0.1154  0.5933  0.5668];
% K22=[-0.2309  0.0544  0.0323;-0.1014  0.2253  0.1581;-0.1180 -0.6588 -0.47416];
% N3=[-54.214 -52.1073 -92.2285;145.531  139.0987  245.3171;-51.654 -48.7388 -85.2332];
% H3=[0.7208  0.0127  0.4484;0.0127  0.9994 -0.0204;0.4484 -0.0204  0.2798];
% T3=[-0.0099 -0.1040  0  0.1140;0.0259  0.2714  0 -0.2973;-0.0087 -0.0911  0  0.0998];
M3=[0.5 0.6 1.2;1.3 0.8 0.9;1.5 0.7 0.4];
% K13=[41.909  24.371  25.74;-111.884 -65.187 -67.648;38.995  22.98  23.135];
% K23=[-42.052 -24.364 -25.494;111.787  65.191  67.759;-38.766 -22.994 -23.487];
% N4=[0.9253  0.3544  0.8586;-0.7457 -0.3121 -0.8786;-0.1374 -0.5212 -0.6305];
% H4=[0.9995  0.0138 -0.0175;0.0138  0.6187  0.4855;-0.0175  0.4855  0.3818];
% T4=[0.0108  0.0008 -0.0116  0;-0.0065 -0.0005  0.007  0;0.0003  0 -0.0003  0];
M4=[0.3 0.5 0.4;0.12  0.56  0.89;0.45  0.36  0.8];
% K14=[-0.3668 -0.8526  0.4048;0.0207  0.5184  0.3019;0.4184  0.6066 -0.0876];
% K24=[0.3855  0.3366  0.2535;-0.0225 -0.4680 -0.3669;-0.4280 -0.3384 -0.2537];

[H1,T1,K11,N1,K21] = com_UIO(A,B1,C,E11,M1);
[H2,T2,K12,N2,K22] = com_UIO(A,B2,C,E21,M2);
[H3,T3,K13,N3,K23] = com_UIO(A,B3,C,E31,M3);
[H4,T4,K14,N4,K24] = com_UIO(A,B4,C,E41,M4);
%% 仿真
iter=100;
u=181.2171*ones(4,1); %输入
u_const=200*ones(4,1);
w=-2*10^(-3) + 4*10^(-3).*rand([4 iter+1]);
eta=-2*10^(-3) + 4*10^(-3).*rand([3 iter+1]);
%原系统
x = zeros(3,iter+1);
y = zeros(3,iter+1);
%SUIO_F1
z_f1 = zeros(3,iter+1);
x_f1 = zeros(3,iter+1);
y_f1 = zeros(3,iter+1);
%SUIO_F2
z_f2 = zeros(3,iter+1);
x_f2 = zeros(3,iter+1);
y_f2 = zeros(3,iter+1);
%SUIO_F3
z_f3 = zeros(3,iter+1);
x_f3 = zeros(3,iter+1);
y_f3 = zeros(3,iter+1);
%SUIO_F4
z_f4 = zeros(3,iter+1);
x_f4 = zeros(3,iter+1);
y_f4 = zeros(3,iter+1);

Error_11= zeros(3,iter+1);
Error_12= zeros(3,iter+1);
Error_13= zeros(3,iter+1);
Error_14= zeros(3,iter+1);
for k=1:iter
    f1=0.1 + 0.05*rand(1);
    f2=0.2 + 0.05*rand(1);
    f3=0.1 + 0.05*rand(1);
    f4=0.2 + 0.05*rand(1);
    if k>=31
        B(:,1)=f1*B(:,1);
    end
    if k==32
        u=u_const;
    end
    %System
    y(:,k) = C * x(:,k)+F*eta(:,k);
    x(:,k+1) = A * x(:,k) + B*u + E * w(:,k);
    
    %SUIO 1
    x_f1(:,k) = M1 * z_f1(:,k) + H1 * y(:,k);
    y_f1(:,k) = C * x_f1(:,k);
    z_f1(:,k+1) = N1 * z_f1(:,k) + T1 * u + (K11+K21) * y(:,k);
    
    %SUIO 2
    x_f2(:,k) = M2 * z_f2(:,k) + H2 * y(:,k);
    y_f2(:,k) = C * x_f2(:,k);
    z_f2(:,k+1) = N2 * z_f2(:,k) + T2 * u+ (K12+K22) * y(:,k);
    
    %SUIO 3
    x_f3(:,k) = M3 * z_f3(:,k) + H3 * y(:,k);
    y_f3(:,k) = C * x_f3(:,k);
    z_f3(:,k+1) = N3 * z_f3(:,k) + T3 * u + (K13+K23) * y(:,k);
    
    %SUIO 4
    x_f4(:,k) = M4 * z_f4(:,k) + H4 * y(:,k);
    y_f4(:,k) = C * x_f4(:,k);
    z_f4(:,k+1) = N4 * z_f4(:,k) + T4 * u + (K14+K24) * y(:,k);
    
    %Residual Error
    e_f1(:,k) = y(:,k) - y_f1(:,k);
    e_f2(:,k) = y(:,k) - y_f2(:,k);
    e_f3(:,k) = y(:,k) - y_f3(:,k);
    e_f4(:,k) = y(:,k) - y_f4(:,k);
    
%     Error_11(:,k+1)=(A-H1*C*A-M1*K11*C)*Error_11(:,k)+(E2-H1*C*E2)*w(2:4,k)-H1*F*eta(:,k+1)-M1*K11*F*eta(:,k);
%     Error_12(:,k+1)=(A-H2*C*A-M2*K12*C)*Error_12(:,k)+(E2-H2*C*E2)*w(2:4,k)...
%         -M2*K12*F*eta(:,k)-H2*F*eta(:,k+1)+(eye(3)-H2*C)*u(1)*(B(:,1)*f1-B(:,1)-B(:,2)*f2+B(:,2));
%     Error_13(:,k+1)=(A-H3*C*A-M3*K13*C)*Error_13(:,k)+(E2-H3*C*E2)*w(2:4,k)...
%         -M3*K13*F*eta(:,k)-H3*F*eta(:,k+1)+(eye(3)-H3*C)*u(1)*(B(:,1)*f1-B(:,1)-B(:,3)*f3+B(:,3));
%     Error_14(:,k+1)=(A-H4*C*A-M4*K14*C)*Error_14(:,k)+(E2-H4*C*E2)*w(2:4,k)...
%         -M4*K14*F*eta(:,k)-H4*F*eta(:,k+1)+(eye(3)-H4*C)*u(1)*(B(:,1)*f1-B(:,1)-B(:,4)*f4+B(:,4));
%     e_f1(:,k) = C*Error_11(:,k)+F*eta(:,k);
%     e_f2(:,k) = C*Error_12(:,k)+F*eta(:,k);
%     e_f3(:,k) = C*Error_13(:,k)+F*eta(:,k);
%     e_f4(:,k) = C*Error_14(:,k)+F*eta(:,k);
end


%% 构造不变集 R1 R21 R31 R41
mid1=A-H1*C*A-M1*K11*C;
mid2=[E2-H1*C*E2 -H1*F -M1*K11*F];
v=[2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3)];
E_set=construct(mid1,mid2,v);
R1=C*E_set+F*V;

mid1=A-H1*C*A-M1*K11*C;
mid2=[E2-H1*C*E2 -H1*F -M1*K11*F eye(3)-H1*C];
[c_21,v_21]=com(2,1);
E_set=construct2(mid1,mid2,[v;v_21],c_21);
R21=C*E_set+F*V;

mid1=A-H1*C*A-M1*K11*C;
mid2=[E2-H1*C*E2 -H1*F -M1*K11*F eye(3)-H1*C];
[c_31,v_31]=com(3,1);
E_set=construct2(mid1,mid2,[v;v_31],c_31);
R31=C*E_set+F*V;

mid1=A-H1*C*A-M1*K11*C;
mid2=[E2-H1*C*E2 -H1*F -M1*K11*F eye(3)-H1*C];
[c_41,v_41]=com(4,1);
E_set=construct2(mid1,mid2,[v;v_41],c_41);
R41=C*E_set+F*V;
%% plot
figure()
subplot(311)
V_1=max(R1.V(:,1));
V_2=min(R1.V(:,1));
fill([V_1 V_1 V_2 V_2],[1 -1 -1 1],'r');
hold on
V_1=max(R21.V(:,1));
V_2=min(R21.V(:,1));
fill([V_1 V_1 V_2 V_2],[1 -1 -1 1],'g');
V_1=max(R31.V(:,1));
V_2=min(R31.V(:,1));
fill([V_1 V_1 V_2 V_2],[1 -1 -1 1],'b');
V_1=max(R41.V(:,1));
V_2=min(R41.V(:,1));
fill([V_1 V_1 V_2 V_2],[1 -1 -1 1],'y');
set(gca,'xtick',-15:5:15);
set(gca,'ytick',-4:4:4);
ylim([-4,4]);
legend('R1(1)','R1,2(1)','R1,3(1)','R1,4(1)','Location','NorthEastOutside');

subplot(312)
V_1=max(R1.V(:,2));
V_2=min(R1.V(:,2));
fill([V_1 V_1 V_2 V_2],[1 -1 -1 1],'r');
hold on
V_1=max(R21.V(:,2));
V_2=min(R21.V(:,2));
fill([V_1 V_1 V_2 V_2],[1 -1 -1 1],'g');
V_1=max(R31.V(:,2));
V_2=min(R31.V(:,2));
fill([V_1 V_1 V_2 V_2],[1 -1 -1 1],'b');
V_1=max(R41.V(:,2));
V_2=min(R41.V(:,2));
fill([V_1 V_1 V_2 V_2],[1 -1 -1 1],'y');
set(gca,'xtick',-1.5:0.5:1.5);
set(gca,'ytick',-4:4:4);
ylim([-4,4]);
legend('R1(2)','R1,2(2)','R1,3(2)','R1,4(2)','Location','NorthEastOutside');

subplot(313)
V_1=max(R1.V(:,3));
V_2=min(R1.V(:,3));
fill([V_1 V_1 V_2 V_2],[1 -1 -1 1],'r');
hold on
V_1=max(R21.V(:,3));
V_2=min(R21.V(:,3));
fill([V_1 V_1 V_2 V_2],[1 -1 -1 1],'g');
V_1=max(R31.V(:,3));
V_2=min(R31.V(:,3));
fill([V_1 V_1 V_2 V_2],[1 -1 -1 1],'b');
V_1=max(R41.V(:,3));
V_2=min(R41.V(:,3));
fill([V_1 V_1 V_2 V_2],[1 -1 -1 1],'y');
set(gca,'xtick',-15:5:15);
set(gca,'ytick',-4:4:4);
ylim([-4,4]);
legend('R1(3)','R1,2(3)','R1,3(3)','R1,4(3)','Location','NorthEastOutside');
%% R2 R3 R4
mid1=A-H2*C*A-M2*K12*C;
mid2=[E2-H2*C*E2 -H2*F -M2*K12*F];
v=[2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3)];
E_set=construct(mid1,mid2,v);
R2=C*E_set+F*V;

mid1=A-H3*C*A-M3*K13*C;
mid2=[E2-H3*C*E2 -H3*F -M3*K13*F];
v=[2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3)];
E_set=construct(mid1,mid2,v);
R3=C*E_set+F*V;

mid1=A-H4*C*A-M4*K14*C;
mid2=[E2-H4*C*E2 -H4*F -M4*K14*F];
v=[2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3);2*10^(-3)];
E_set=construct(mid1,mid2,v);
R4=C*E_set+F*V;

% R1.contains(e_f1(:,50))
% R2.contains(e_f2(:,50))
% R3.contains(e_f3(:,50))
% R4.contains(e_f4(:,50))

%% 通道1
figure()
V_1=max(R1.V(:,1));
x=ones(1,100)*V_1;
plot(x,'r');hold on;
V_2=min(R1.V(:,1));
x=ones(1,100)*V_2;
plot(x,'r');hold on;

V_1=max(R2.V(:,1));
x=ones(1,100)*V_1;
plot(x,'g');hold on;
V_2=min(R2.V(:,1));
x=ones(1,100)*V_2;
plot(x,'g');hold on;

V_1=max(R3.V(:,1));
x=ones(1,100)*V_1;
plot(x,'b');hold on;
V_2=min(R3.V(:,1));
x=ones(1,100)*V_2;
plot(x,'b');hold on;

V_1=max(R4.V(:,1));
x=ones(1,100)*V_1;
plot(x,'black');hold on;
V_2=min(R4.V(:,1));
x=ones(1,100)*V_2;
plot(x,'black');hold on;

plot(e_f1(1,:),'-.r');hold on;
plot(e_f2(1,:),'-.g');hold on;
plot(e_f3(1,:),'-.b');hold on;
plot(e_f4(1,:),'-.black');hold off;
title('通道1')
legend('R1(1)','','R2(1)','','R3(1)','','R4(1)','','r1(1)','r2(1)','r3(1)','r4(1)')
%% 通道2
figure()
V_1=max(R1.V(:,2));
x=ones(1,100)*V_1;
plot(x,'r');hold on;
V_2=min(R1.V(:,2));
x=ones(1,100)*V_2;
plot(x,'r');hold on;

V_1=max(R2.V(:,2));
x=ones(1,100)*V_1;
plot(x,'g');hold on;
V_2=min(R2.V(:,2));
x=ones(1,100)*V_2;
plot(x,'g');hold on;

V_1=max(R3.V(:,2));
x=ones(1,100)*V_1;
plot(x,'b');hold on;
V_2=min(R3.V(:,2));
x=ones(1,100)*V_2;
plot(x,'b');hold on;

V_1=max(R4.V(:,2));
x=ones(1,100)*V_1;
plot(x,'black');hold on;
V_2=min(R4.V(:,2));
x=ones(1,100)*V_2;
plot(x,'black');hold on;

plot(e_f1(2,:),'-.r');hold on;
plot(e_f2(2,:),'-.g');hold on;
plot(e_f3(2,:),'-.b');hold on;
plot(e_f4(2,:),'-.black');hold off;
title('通道2')
legend('R1(2)','','R2(2)','','R3(2)','','R4(2)','','r1(2)','r2(2)','r3(2)','r4(2)')
%% 通道3
figure()
V_1=max(R1.V(:,3));
x=ones(1,100)*V_1;
plot(x,'r');hold on;
V_2=min(R1.V(:,3));
x=ones(1,100)*V_2;
plot(x,'r');hold on;

V_1=max(R2.V(:,3));
x=ones(1,100)*V_1;
plot(x,'g');hold on;
V_2=min(R2.V(:,3));
x=ones(1,100)*V_2;
plot(x,'g');hold on;

V_1=max(R3.V(:,3));
x=ones(1,100)*V_1;
plot(x,'b');hold on;
V_2=min(R3.V(:,3));
x=ones(1,100)*V_2;
plot(x,'b');hold on;

V_1=max(R4.V(:,3));
x=ones(1,100)*V_1;
plot(x,'black');hold on;
V_2=min(R4.V(:,3));
x=ones(1,100)*V_2;
plot(x,'black');hold on;

plot(e_f1(3,:),'-.r');hold on;
plot(e_f2(3,:),'-.g');hold on;
plot(e_f3(3,:),'-.b');hold on;
plot(e_f4(3,:),'-.black');hold off;

title('通道3')
legend('R1(3)','','R2(3)','','R3(3)','','R4(3)','','r1(3)','r2(3)','r3(3)','r4(3)')


